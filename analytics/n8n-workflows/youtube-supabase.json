{
  "name": "YouTube Analytics → Supabase - Métricas Diárias",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "30 9 * * *"
            }
          ]
        }
      },
      "name": "Schedule Trigger - Diário 9:30h",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300],
      "id": "schedule-yt-trigger"
    },
    {
      "parameters": {
        "resource": "channel",
        "operation": "get",
        "channelId": "={{$env.YOUTUBE_CHANNEL_ID}}",
        "part": "statistics,contentDetails",
        "options": {}
      },
      "name": "YouTube - Buscar Estatísticas Canal",
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [450, 300],
      "id": "youtube-channel-node",
      "credentials": {
        "youTubeOAuth2Api": "YouTube"
      }
    },
    {
      "parameters": {
        "jsCode": "// Processar dados do YouTube\nconst ytData = items[0].json;\nconst stats = ytData.statistics || {};\n\n// Extrair métricas\nconst viewCount = parseInt(stats.viewCount || 0);\nconst subscriberCount = parseInt(stats.subscriberCount || 0);\nconst videoCount = parseInt(stats.videoCount || 0);\n\n// Calcular delta (assumir que temos dados de ontem no Supabase)\n// Em produção, buscar de ontem e fazer diff\nconst estimatedNewViews = Math.round(viewCount * 0.01); // ~1% são de ontem\nconst estimatedNewSubscribers = Math.round(subscriberCount * 0.001); // ~0.1% são de ontem\n\n// Data de ontem\nconst yesterday = new Date();\nyesterday.setDate(yesterday.getDate() - 1);\nconst dataFormatted = yesterday.toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    data: dataFormatted,\n    source: 'youtube',\n    \n    // Métricas YouTube\n    views: estimatedNewViews,\n    watch_time: 0, // Requer YouTube Analytics API (não Channel API)\n    subscribers_gained: estimatedNewSubscribers,\n    \n    // Métricas padrão (zero para YouTube orgânico)\n    spend: 0,\n    budget: 0,\n    reach: estimatedNewViews,\n    impressions: estimatedNewViews,\n    clicks: 0,\n    ctr: 0,\n    cpc: 0,\n    cpe: 0,\n    cpm: 0,\n    conversions: estimatedNewSubscribers,\n    new_followers: estimatedNewSubscribers,\n    cost_per_follower: 0,\n    \n    // Metadata\n    notes: `YouTube: ${estimatedNewViews} views estimadas ontem, ${estimatedNewSubscribers} inscritos novos, total ${subscriberCount}`,\n    raw_data: ytData\n  }\n}];"
      },
      "name": "Process YouTube Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300],
      "id": "code-process-yt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/daily_metrics",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "Bearer ={{$env.SUPABASE_SERVICE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "name": "Supabase - Insert Metrics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [850, 300],
      "id": "supabase-insert-yt"
    },
    {
      "parameters": {},
      "name": "Success",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1050, 300],
      "id": "success-node-yt"
    }
  ],
  "connections": {
    "Schedule Trigger - Diário 9:30h": {
      "main": [
        [
          {
            "node": "YouTube - Buscar Estatísticas Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "YouTube - Buscar Estatísticas Canal": {
      "main": [
        [
          {
            "node": "Process YouTube Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process YouTube Data": {
      "main": [
        [
          {
            "node": "Supabase - Insert Metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Insert Metrics": {
      "main": [
        [
          {
            "node": "Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "tags": [
    {
      "name": "marketing",
      "id": "marketing-tag"
    },
    {
      "name": "youtube",
      "id": "yt-tag"
    }
  ]
}

